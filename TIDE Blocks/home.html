<!DOCTYPE html>
<html style="overflow: hidden;">

<head>
	<title>TIDE Blocks</title>
	<link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="./css/scrollbar.css">
	<link rel="stylesheet" type="text/css" href="./css/custom.css">
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<script>window.$ = window.jQuery = require('./js/jquery.min.js');</script>
	<script>require('./js/jquery-ui.min.js');</script>
	<script>require('./js/bootstrap.min.js');</script>
</head>

<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand">TIDE Blocks</a>
			</div>
			<ul class="nav navbar-nav">
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Archivo</a>
					<ul class="dropdown-menu">
						<li><a id="open-files">Abrir</a></li>
						<li><a id="save-files">Guardar</a></li>
						<li><a id="saveas-files">Guardar Como</a></li>
						<li class="divider"></li>
						<li><a>Exportar</a></li>
						<li><a id="file-compiler">Compilar</a></li>
						<li class="divider"></li>
						<li><a>Salir</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Edición</a>
					<ul class="dropdown-menu">
						<li><a>Undo</a></li>
						<li><a>Redo</a></li>
						<li class="divider"></li>
						<li><a>Cortar</a></li>
						<li><a>Copiar</a></li>
						<li><a>Pegar</a></li>
						<li><a>Borrar</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Ayuda</a>
					<ul class="dropdown-menu">
						<li><a>Aprende más</a></li>
						<li><a>Documentación</a></li>
						<li><a>Acerca de nosotros</a></li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a id="nav-mini"><span class="glyphicon glyphicon-minus"></span></a></li>
				<li><a id="nav-maxi"><span class="glyphicon glyphicon-unchecked"></span></a></li>
				<li><a id="nav-exit"><span class="glyphicon glyphicon-remove"></span></a></li>
			</ul>
		</div>
	</nav>
	<main class="scrollbar scrollbar-default">
		<div id="blocks-container">
			<div class="block-container">
				<div id="Setter" class="block block-default">Default</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-primary">Primary</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-success">Success</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-info">Info</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-warning">Warning</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-danger">Danger</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-default">Default
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-primary">Primary
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-success">Success
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-info">Info
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-warning">Warning
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-danger">Danger
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
		</div>
		<button type="button" id="separator" class="btn btn-default">&laquo;</button>
		<div>
			<ul id="project-navegator" class="nav nav-tabs row">
				<li id="add-project-btn" class=""><a id="add-project" aria-expanded="true">+</a></li>
				<li id="hidden-projects-btn" class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="true">
		      			<span class="caret"></span>
		    		</a>
					<ul id="list-projects" class="dropdown-menu dropdown-menu-right"></ul>
			    </li>
			</ul>
		</div>
		
		<div id="workspace-container" class="scrollbar scrollbar-primary">
			<div id="project-content" class="tab-content"></div>
		</div>
	</main>
	<script>
		// electron imports
		const electron = require('electron')
		const { ipcRenderer } = electron;
		//id Para archivos nuevos, pero no existentes
		let idProject = 0;
		// Open file
		$('#open-files').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('open:files');
		});
		//Saveas Files
		$('#saveas-files').on('click', function (event) {
			event.preventDefault();
			if($('#project-navegator .active').attr('name') != null) {
				ipcRenderer.send('saveas:files');
			}
		});
		//Save Files
		$('#save-files').on('click', function(event){
			event.preventDefault();
			if($('#project-navegator .active').attr('name') != null) {
				if($('#project-navegator .active a').text() == 'Nuevo Proyecto x'){
					ipcRenderer.send('saveas:files');
				}else{
					ipcRenderer.send('save:file', ($( "#"+$('#project-navegator .active').attr('name')).clone().removeClass('active').removeClass('in')).prop('outerHTML'), ($( "#"+$('#project-navegator .active').attr('name'))).attr('path'));
				}
			}
		});
		// Events
		$('#file-compiler').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('test:compiler', $('#workspace-code-container').val());
		});
		//Add New project to projects navegator
		$('#add-project').on('click', function (event) {
			event.preventDefault();
			add_project('Project'+idProject, false);
			idProject+=1;
		});
		//Remove Project
		$('#project-navegator').on('click','.close', function(event){
			event.preventDefault();
			remove_project(event);
		});
		// Minimize
		$('#nav-mini').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:mini');
		});
		// Maximize
		$('#nav-maxi').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:maxi');
		});
		// Close
		$('#nav-exit').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:exit');
		});
		// Open dialog
		$('#file-open').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('file:open');
		});
		// Colapse blocks container
		$('#separator').on('click', function (event) {
			event.preventDefault();
			if ($('#blocks-container').css('display') != 'none') {
				$('#blocks-container').css('display', 'none');
				$('#separator').css('left', '1px');
				$('#workspace-container').css('left', '11px');
				$('#project-navegator').css('left', '26px');
				update_tabs();
			} else {
				$('#blocks-container').css('display', 'block');
				$('#separator').css('left', '301px');
				$('#workspace-container').css('left', '311px');
				$('#project-navegator').css('left', '326px');
				update_tabs();
			}
		});

		window.addEventListener('resize', function(e){
	    	e.preventDefault();
	    	update_tabs();
	    })

	    function update_tabs() {
	    	$.each($('#project-navegator').children(), function(indx, tab) {
	    		if((((indx+1) * $(tab).width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width() > $('#project-navegator').width()) || $('#project-navegator').children().length-1 == 1) && (tab != $('#add-project').parent()[0] && tab != $('#list-projects').parent()[0])){
	    			$(tab).remove();
	    		}
	    	});
	    	$.each($('#list-projects').children(), function(indx, tab) {
	    		if($('li[name="'+$(tab).attr('name')+'"]' ).length == 1){
	    			if(((($('#project-navegator').children().length - 1) * $(tab).width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width()) < $('#project-navegator').width() || $('#project-navegator').children().length-1 == 1) && (tab != $('#add-project').parent()[0] && tab != $('#list-projects').parent()[0])) {
	    				$($(tab).clone()).insertBefore($('#add-project').parent());
	    			}
	    		}
	    	});
	    }

		function add_project(arg, isNew, filecontent=null) {
			nameProject=arg;
			arg = arg.replace('.', 'punto');
			if(!isNew) nameProject="Nuevo Proyecto";
			if(filecontent){
				$('#project-content').append($($.parseHTML(filecontent))
					.sortable({
						connectWith: ".sortable",
						receive: sortable_receive,
						change: sortable_update,
						over: sortable_update,
						out: sortable_update
					}).disableSelection()
				);
			}else{
				$('#project-content').append($(document.createElement('div'))
					.attr('id', arg)
					.attr('class', 'tab-pane fade sortable tab-project')
					.sortable({
						connectWith: ".sortable",
						receive: sortable_receive,
						change: sortable_update,
						over: sortable_update,
						out: sortable_update
					}).disableSelection()
				);
			}
			$('#add-project').parent().before($(document.createElement('li'))
				.attr('name', arg)
				.attr('class', 'tab-design')
				.attr('path', ' ')
				.append($(document.createElement('a'))
					.attr('href', '#'+arg)
					.attr('data-toggle', 'tab')
					.attr('aria-expanded', 'false')
					.text(nameProject)
					.append($(document.createElement('button'))
						.attr('class', 'close')
						.attr('type', 'button')
						.text(' x')
					)
				)
			);
			$('#list-projects').append($(document.createElement('li'))
				.attr('name', arg)
				.attr('class', 'tab-design')
				.attr('path', ' ')
				.append($(document.createElement('a'))
					.attr('href', '#'+arg)
					.attr('data-toggle', 'tab')
					.attr('aria-expanded', 'false')
					.text(nameProject)
					.append($(document.createElement('button'))
						.attr('class', 'close')
						.attr('type', 'button')
						.text(' x')
					)
				)
			);
			update_tabs();
		}

		function remove_project(event) {
			$($(event.currentTarget).parent().attr('href')).remove();
			$.each($('li[name="'+$(event.currentTarget).parent().attr('href').substr(1)+'"]'), function(indx, tab) {
				tab.remove();
			});
			update_tabs();
		}

		function update_element(element, sumhb) {
			if (sumhb < 0) {
				sumhb = 0;
			}
			$(element).css({
				'background-position': '0px 0px, 80px 0px, 130px 0px, 0px 10px, 80px 10px, 130px 10px, 0px 20px, 80px 20px, 130px 20px, 0px 40px, 80px 40px, 130px 40px, 0px ' + (40 + sumhb) + 'px, 80px ' + (40 + sumhb) + 'px, 130px ' + (40 + sumhb) + 'px, 0px ' + (60 + sumhb) + 'px, 80px ' + (60 + sumhb) + 'px, 130px ' + (60 + sumhb) + 'px, 0px ' + (70 + sumhb) + 'px, 80px ' + (70 + sumhb) + 'px, 130px ' + (70 + sumhb) + 'px',
				'background-size': '80px 10px, 50px 10px, 10px 10px, 80px 10px, 50px 10px, 10px 10px, 80px 20px, 50px 20px, 10px 20px, 80px ' + sumhb + 'px, 50px ' + sumhb + 'px, 10px ' + sumhb + 'px, 80px 20px, 50px 20px, 10px 20px, 80px 10px, 50px 10px, 10px 10px, 80px 15px, 50px 15px, 10px 15px',
				'min-height': (85 + sumhb) + 'px',
				'height': (85 + sumhb) + 'px',
				'max-height': (85 + sumhb) + 'px'
			});
		}

		function sortable_update(event, ui) {
			var ws = $('#workspace-container')
			if (ws.length) {
				var bs = ws[0].children;
				for (var i = 0; i < bs.length; i++) {
					var b = bs[i];
					if ((' ' + b.className + ' ').indexOf(' container-block ') > -1) {
						update_element(b, sum_height_blocks(b) - 20)
					}
				}
			}
		}

		function sum_height_blocks(element) {
			var cn = $(element).find('.sortable')
			var sumhb = 0;
			if (cn.length) {
				var bs = cn[0].children;
				for (var i = 0; i < bs.length; i++) {
					var b = bs[i];
					if ((' ' + b.className + ' ').indexOf(' container-block ') > -1) {
						update_element(b, sum_height_blocks(b) - 20)
					}
					sumhb += parseInt($(b).css('height')) + parseInt($(b).css('margin-bottom'));
				}
			}
			return sumhb;
		}

		function sortable_receive(event, ui) {
			$('.sortable').sortable({
				connectWith: ".sortable",
				receive: sortable_receive,
				change: sortable_update,
				over: sortable_update,
				out: sortable_update,
			});
		}

		$(".block-container").sortable({
			connectWith: ".sortable",
			remove: function (event, ui) {
				$(this).html(ui.item.clone())
			},
			change: sortable_update,
			over: sortable_update,
			out: sortable_update
		}).disableSelection();

		$(".sortable").sortable({
			connectWith: ".sortable",
			receive: sortable_receive,
			change: sortable_update,
			over: sortable_update,
			out: sortable_update
		}).disableSelection();

		ipcRenderer.on('contentData', (event, data, filepath, system)=>{				
			newId = '';
			if(system == 'windows'){
				newId = filepath.substr(filepath.lastIndexOf("\\") + 1);
			}else{
				newId = filepath.substr(filepath.lastIndexOf("/") + 1)
			}
			if($('li[name="'+newId.replace('.','punto')+'"]' ).length == 0){
				add_project(newId, true, data);
			}
		});

		ipcRenderer.on('update:name-project', (event, filepath, system)=> {
			newId = '';
			$("#"+$('#project-navegator .active').attr('name')).attr('path', filepath);
			$( "li[name='"+$('#project-navegator .active').attr('name')+"']").attr('path', filepath);
			if(system == 'windows'){
				newId = filepath.substr(filepath.lastIndexOf("\\") + 1);
			}else{
				newId = filepath.substr(filepath.lastIndexOf("/") + 1)
			}
			$( "#"+$('#project-navegator .active').attr('name')).attr('id', newId.replace('.', 'punto'));
			$( "li[name='"+$('#project-navegator .active').attr('name')+"'] a").attr('href', '#'+newId.replace('.','punto'));
			$( "li[name='"+$('#project-navegator .active').attr('name')+"'] a").text(newId);
			$( "li[name='"+$('#project-navegator .active').attr('name')+"'] a").append($(document.createElement('button'))
					.attr('class', 'close')
					.attr('type', 'button')
					.text(' x')
				);
			$( "li[name='"+$('#project-navegator .active').attr('name')+"']").attr('name', newId.replace('.','punto'));
			ipcRenderer.send('ready:tosave', ($( "#"+$('#project-navegator .active').attr('name')).clone().removeClass('active').removeClass('in')).prop('outerHTML'), filepath);
		});
	</script>
</body>

</html>
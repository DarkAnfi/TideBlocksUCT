<!DOCTYPE html>
<html style="overflow: hidden;">

<head>
	<title>TIDE Blocks</title>
	<link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="./css/scrollbar.css">
	<link rel="stylesheet" type="text/css" href="./css/custom.css">
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<link rel="stylesheet" type="text/css" href="./css/block.css">
	<script>window.$ = window.jQuery = require('./js/jquery.min.js');</script>
	<script>require('./js/jquery-ui.min.js');</script>
	<script>require('./js/bootstrap.min.js');</script>
	<script>require('./js/jquery.mjs.nestedSortable.js');</script>
</head>

<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand">TIDE Blocks</a>
			</div>
			<ul class="nav navbar-nav">
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Archivo</a>
					<ul class="dropdown-menu">
						<li><a id="new-file">Nuevo Archivo<span class="shortcut-tag"><i>Ctrl+N</i></span></a></li>
						<li><a id="open-files">Abrir<span class="shortcut-tag"><i>Ctrl+O</i></span></a></li>
						<li><a id="save-files">Guardar<span class="shortcut-tag"><i>Ctrl+S</i></span></a></li>
						<li><a id="saveas-files">Guardar Como</a></li>
						<li class="divider"></li>
						<li><a>Exportar</a></li>
						<li><a id="file-compile">Compilar<span class="shortcut-tag"><i>Ctrl+Shift+C</i></span></a></li>
						<li class="divider"></li>
						<li class="dropdown dropdown-submenu">
							<a class="dropdown-toggle" data-toggle="dropdown">Preferencias</a>
							<ul class="dropdown-menu">
								<li class="dropdown dropdown-submenu">
									<a class="dropdown-toggle" data-toggle="dropdown">Puerto</a>
									<ul class="dropdown-menu" id="menu-ports">
									</ul>
								</li>
							</ul>
						</li>
						<li class="divider"></li>
						<li><a>Salir</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a id="edit-menu" class="dropdown-toggle" data-toggle="dropdown">Edición</a>
					<ul class="dropdown-menu">
						<li><a>Undo</a></li>
						<li><a>Redo</a></li>
						<li class="divider"></li>
						<li><a>Cortar</a></li>
						<li><a>Copiar</a></li>
						<li><a>Pegar</a></li>
						<li><a>Borrar</a></li>
						<li class="divider"></li>
						<li><a id="rename-project" data-toggle="modal" data-target="#rename-modal" href=""> Cambiar
								nombre</a></li>
						<li><a data-toggle="modal" data-target="#variables">Variables<span
									class="shortcut-tag"><i>Ctrl+Shift+V</i></span></a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Ayuda</a>
					<ul class="dropdown-menu">
						<li><a>Aprende más</a></li>
						<li><a>Documentación</a></li>
						<li><a>Acerca de nosotros</a></li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a id="nav-mini"><span class="glyphicon glyphicon-minus"></span></a></li>
				<li><a id="nav-maxi"><span class="glyphicon glyphicon-unchecked"></span></a></li>
				<li><a id="nav-exit"><span class="glyphicon glyphicon-remove"></span></a></li>
			</ul>
		</div>
	</nav>
	<div id="shortcuts-bar">
		<span id="shortcut-file" class="shortcut glyphicon glyphicon-file" data-toggle="tooltip" data-placement="bottom"
			title="Nuevo Archivo (Ctrl + N)"></span>
		<span id="shortcut-open" class="shortcut glyphicon glyphicon-folder-open" data-toggle="tooltip"
			data-placement="bottom" title="Abrir Archivo (Ctrl + O)"></span>
		<span id="shortcut-save" class="shortcut glyphicon glyphicon-floppy-disk" data-toggle="tooltip"
			data-placement="bottom" title="Guardar Archivo (Ctrl + S)"></span>
		<span id="shortcut-compile" class="shortcut glyphicon glyphicon-play-circle" data-toggle="tooltip"
			data-placement="bottom" title="Compilar Archivo (Ctrl + Shift + C)"></span>
		<button id="shortcut-variable" class="btn btn-default btn-xs" type="button" data-toggle="modal"
			data-target="#variables">
			<span id="plus-sign" class="glyphicon glyphicon-plus-sign" data-toggle="tooltip" data-placement="left"
				title="(Ctrl + Shift + V)"></span><span data-toggle="tooltip" data-placement="left"
				title="(Ctrl + Shift + V)">Variable</span>
		</button>


	</div>
	<main class="scrollbar scrollbar-default">
		<div id="blocks-container">
			<div id="block-menu" class="row">
				<button class="block-menu-option btn btn-primary btn-sm col-xs-6 active" href="#vars" data-toggle="tab"
					aria-expanded="true">Variables</button>
				<button class="block-menu-option btn btn-primary btn-sm col-xs-6" href="#controls" data-toggle="tab"
					aria-expanded="true">Control</button>
				<button class="block-menu-option btn btn-primary btn-sm col-xs-6" href="#operators" data-toggle="tab"
					aria-expanded="true">Operadores</button>
				<button class="block-menu-option btn btn-primary btn-sm col-xs-6" href="#makers" data-toggle="tab"
					aria-expanded="true">Maker</button>
			</div>
			<div id="block-content" class="tab-content">
				<div class="scrollbar scrollbar-primary tab-pane fade active in block-section" id="vars">

				</div>
				<div class="scrollbar scrollbar-primary tab-pane fade block-section" id="controls">
					<ul class="block-container">
						<li data-block="if">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Si</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="1" />
												</div>
											</td>
											<td>entonces</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block="else">
							<div>
								<table>
									<tbody>
										<tr>
											<td>De lo contrario entonces</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block="while">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Repetir mientras</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="1" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block="repeat">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Repetir</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="1" />
												</div>
											</td>
											<td>veces</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block='delay' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Esperar</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="1000" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block='setter' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<select class="variableList form-control input-sm" value="_NULL">
													<option value="_NULL" selected>Variable</option>
												</select>
											</td>
											<td>=</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
				</div>


				<div class="scrollbar scrollbar-primary tab-pane fade block-section" id="operators">
					<div class="value-container">
						<div data-block="value" data-name="sum">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>+</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="rest">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												-
											</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="mult">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												*
											</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="div">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												/
											</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="igual">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												=
											</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="mayor">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												>
											</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="menor">
							<div>
								<table>
									<tbody>
										<tr>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
											<td>
												< </td> <td>
													<div class="value-slot">
														<input class="form-control input-sm" value="0" />
													</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>


				</div>

				<div class="scrollbar scrollbar-primary tab-pane fade block-section" id="makers">
					<ul class="block-container">
						<li data-block='led-on' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Encender LED</td>
											<td>
												<select class="form-control input-sm" value="13">
													<option value="13" selected>Blanco</option>
													<option value="6">Rojo</option>
													<option value="5">Amarillo</option>
													<option value="4">Verde</option>
												</select>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block='led-off' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Apagar LED</td>
											<td>
												<select class="form-control input-sm" value="13">
													<option value="13" selected>Blanco</option>
													<option value="6">Rojo</option>
													<option value="5">Amarillo</option>
													<option value="4">Verde</option>
												</select>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block='servo1' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Servo 1</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<ul class="block-container">
						<li data-block='servo2' class="locked">
							<div>
								<table>
									<tbody>
										<tr>
											<td>Servo 2</td>
											<td>
												<div class="value-slot">
													<input class="form-control input-sm" value="0" />
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</li>
					</ul>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(3)">
							<div>Sensor de Sonido</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(4)">
							<div>Sensor de Luz</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(5)">
							<div>Sensor de Temperatura</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="digitalRead(3)">
							<div>Digital A</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(0)">
							<div>Analogo B</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(1)">
							<div>Analogo C</div>
						</div>
					</div>
					<div class="value-container">
						<div data-block="value" data-name="analogRead(2)">
							<div>Analogo D</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		</div>
		<button type="button" id="separator" class="btn btn-default">&laquo;</button>
		<div>
			<ul id="project-navegator" class="nav nav-tabs row">
				<li id="add-project-btn" class=""><a id="add-project" aria-expanded="true">+</a></li>
				<li id="hidden-projects-btn" class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="true">
						<span class="caret"></span>
					</a>
					<ul id="list-projects" class="dropdown-menu dropdown-menu-right"></ul>
				</li>
			</ul>
		</div>

		<div id="workspace-container" class="scrollbar scrollbar-primary">
			<div id="project-content" class="tab-content"></div>
		</div>
		<div class="modal fade scrollbar-default" id="rename-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Cambiar nombre de proyecto</h4>
					</div>
					<div class="modal-body">
						Nuevo nombre: <input id="rename" type="text">
					</div>
					<div class="modal-footer">
						<button id="rename-accept" class="btn btn-default" type="button"
							data-dismiss="modal">Aceptar</button>
						<button id="rename-cancel" class="btn btn-danger" type="button"
							data-dismiss="modal">Cancelar</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade scrollbar scrollbar-default" id="ipc-renderer-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title"></h4>
					</div>
					<div class="modal-body"></div>
					<div class="modal-footer" style="display: none">
						<button class="btn btn-default" type="button" data-dismiss="modal">Cerrar</button>
					</div>
				</div>
			</div>
		</div>
	</main>
	<div id="variables" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title">Variables</h4>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-xs-6">
							<div class="form-group">
								<label class="control-label" for="variable-name">Nombre de la variable</label>
								<input id="variable-name" type="text" class="form-control" placeholder="Nombre">
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<label class="control-label" for="variable-type">Tipo de dato</label>
								<select id="variable-type" class="form-control" value="int">
									<option value="int" selected>Entero</option>
									<option value="float">Flotante</option>
									<option value="bool">Booleano</option>
								</select>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button id="variable-add" type="button" class="btn btn-info">Agregar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal">Volver</button>
				</div>
			</div>
		</div>
	</div>
	<script>
		/* Imports */

		const electron = require('electron');
		const { ipcRenderer } = electron;
		const html2json = require('html-to-json');
		const path = require('path');
		const serialport = require('serialport');
		const Interpreter = require('./js/interpreter');

		let idProject = 0;
		let interpreter = new Interpreter();

		/* General Functions */

		function update_tabs() {
			let active = null;
			$.each($('#project-navegator').children(), function (indx, tab) {
				if (((Math.floor((indx + 1) * $(tab).width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width()) > $('#project-navegator').width()) || $('#project-navegator').children().length - 1 == 1) && (tab != $('#add-project').parent()[0] && tab != $('#list-projects').parent()[0])) {
					if ($(tab).hasClass('active') !== !active) {
						active = tab;
					}
					$(tab).remove();
					$('#list-projects').append($($(tab).clone().on('click', handlerTabActive)));
				}
			});
			$.each($('#list-projects').children(), function (indx, tab) {
				if ($('#project-navegator > li[name="' + $(tab).attr('name') + '"]').attr('name') == null) {
					if (Math.floor(($('#project-navegator').children().length - 1) * $('.tab-design').width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width()) < $('#project-navegator').width() || $('#project-navegator').children().length - 1 == 1) {
						if ($(tab).hasClass('active') && !active) {
							active = tab;
						}
						$(tab).remove();
						$($(tab).clone().on('click', handlerTabActive)).insertBefore($('#add-project').parent());
					}
				}
			});
			if (active !== null) {
				$('#project-navegator .active').removeClass('in active');
				$('#list-projects .active').removeClass('in active');
				$('li[name="' + $(active).attr('name') + '"]').addClass('in active');
			}
		}

		$("[data-toggle=tooltip").tooltip();

		function add_project(arg, isNew, filecontent = null) {
			nameProject = arg;
			newPath = ' '
			arg = arg.replace('.', 'punto');
			if (!isNew) nameProject = "Nuevo Proyecto";
			$('#project-content .active').removeClass('active in');
			$('#project-navegator .active').removeClass('active in');
			if (filecontent) {
				$('#project-content').append($($.parseHTML(filecontent))
					.addClass('active in'))
					.find('.sortable').nestedSortable({
						listType: 'ul',
						handle: 'div',
						items: 'li',
						toleranceElement: '> div',
						cancel: "div[data-block='value'],input,textarea,button,select,option",
						isAllowed: sortableIsAllowed
					})
					.find('li')
					.on('click', handlerBlockClick)
					.find('input, select')
					.on('change', handlerUpdateArgs)
					.on('keypress', handlerUpdateArgs);
				newPath = $('#' + arg).attr('path');
			} else {
				$('#project-content').append($(document.createElement('ul'))
					.attr('id', arg)
					.attr('class', 'active in')
					.attr('path', ' ')
					.attr('class', 'tab-pane fade sortable tab-project active in')
					.nestedSortable({
						listType: 'ul',
						handle: 'div',
						items: 'li',
						toleranceElement: '> div',
						cancel: "div[data-block='value'],input,textarea,button,select,option",
						isAllowed: sortableIsAllowed
					})
				);
			}
			$('#add-project').parent().before($(document.createElement('li'))
				.attr('name', arg)
				.attr('class', 'tab-design active in')
				.attr('path', newPath)
				.attr('data-toggle', 'tooltip')
				.attr('data-placement', 'bottom')
				.attr('title', nameProject)
				.append($(document.createElement('a'))
					.attr('href', '#' + arg)
					.attr('class', 'tab-design')
					.attr('data-toggle', 'tab')
					.attr('aria-expanded', 'false')
					.append($(document.createElement('span'))
						.attr('class', 'tab-label')
						.text(nameProject)
					)
					.append($(document.createElement('button'))
						.attr('class', 'close')
						.attr('type', 'button')
						.text(' x')
					)
				)
				.on('click', handlerTabActive)
			);
			update_tabs();
		}

		function remove_project(event) {
			$($(event.currentTarget).parent().attr('href')).remove();
			$.each($('li[name="' + $(event.currentTarget).parent().attr('href').substr(1) + '"]'), function (indx, tab) {
				tab.remove();
			});
			update_tabs();
		}

		function update_nameProject(filepath, isNew) {
			newId = path.basename(filepath);
			if (isNew) {
				newPath = ' '
			} else {
				newPath = path.dirname(filepath);
			}
			$("#" + $('#project-navegator .active').attr('name')).attr('path', newPath);
			$("li[name='" + $('#project-navegator .active').attr('name') + "']").attr('path', newPath);
			$("li[name='" + $('#project-navegator .active').attr('name') + "']").attr('title', newId);
			$("#" + $('#project-navegator .active').attr('name')).attr('id', newId.replace('.', 'punto'));
			$("li[name='" + $('#project-navegator .active').attr('name') + "'] a").attr('href', '#' + newId.replace('.', 'punto'));
			$("li[name='" + $('#project-navegator .active').attr('name') + "'] a span").text(newId);
			$("li[name='" + $('#project-navegator .active').attr('name') + "']").attr('name', newId.replace('.', 'punto'));
		}

		/* Event Handlers */

		function handlerListPorts(event, ports) {
			$('#menu-ports').html(null)
			ports.forEach(port => {
				$('#menu-ports').append($(document.createElement('li'))
					.html($(document.createElement('a'))
						.text(port.comName)
						.click(() => {
							ipcRenderer.send('set:port', port.comName);
						})
					)
				);
			});
		}

		function handlerRefreshPortList(event) {
			serialport.list(handlerListPorts);
		}

		function handlerScrollLeft(event) {
			if ($(this).scrollLeft() !== 0) {
				$(this).scrollLeft(0);
			}
		}

		function handlerBlockTableInputChange(event) {
			$(this).closest('[data-block]')
		}

		function handlerDropdownClick(event) {
			event.preventDefault();
			event.stopPropagation();
			$(this).parent().siblings().removeClass('open');
			$(this).parent().toggleClass('open');
		}

		function handlerEditMenuClick(event) {
			if ($('#project-navegator .active').attr('name') == null) {
				$('#rename-project').parent().addClass('disabled');
			} else {
				$('#rename-project').parent().removeClass('disabled');
			}
		}

		function handlerNewFileClick(event) {
			event.preventDefault();
			add_project('Project' + idProject, false);
			idProject += 1;
		}

		function handlerOpenFileClick(event) {
			event.preventDefault();
			ipcRenderer.send('open:files');
		}

		function handlerSaveAsFileClick(event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				ipcRenderer.send('saveas:files');
			}
		}

		function handlerSaveFileClick(event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				if ($('#project-navegator .active').attr('path') == ' ') {
					ipcRenderer.send('saveas:files');
				} else {
					ipcRenderer.send('ready:tosave', ($("#" + $('#project-navegator .active').attr('name')).clone()).prop('outerHTML'), path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#project-navegator .active a').text().slice(0, -2)));
				}
			}
		}

		function handlerFileCompileClick(event) {
			event.preventDefault();
			if ($('#file-compile').parent().hasClass('disabled') == false) {
				if ($("#" + $("#project-navegator .active").attr('name')).html()) {
					const original = $("#" + $("#project-navegator .active").attr('name')).html()
					let result = "";
					for (let i = 0; i < original.length; i++) {
						let hex = original.charCodeAt(i).toString(16);
						hex = "0x" + ("000" + hex).slice(-4);
						result += hex == "0x0009" ? '' :
							hex == "0x000a" ? '' :
								hex;
					}
					let raw = ""
					for (let i = 0; i < result.length - 5; i += 6) {
						const hex = result[i + 2] + result[i + 3] + result[i + 4] + result[i + 5];
						raw += String.fromCharCode(Number.parseInt(hex, 16));
					}
					html2json.parse(raw, function (data) {
						if (data.length) {
							if (data[0].children) {
								$('#file-compile').parent().addClass('disabled');
								$(function () {
									interpreter.html(data[0].children);
									const nodeHtml = interpreter.html();
									const nodeCode = interpreter.prepare();
									const txCode = interpreter.getCode();
									console.log(nodeHtml);
									console.log(nodeCode);
									console.log(txCode);
									ipcRenderer.send('file:compile', txCode);
								});
							}
						}
					})
				}
			}
		}

		function handlerRenameProjectClick(event) {
			event.preventDefault();
			if ($(this).parent().hasClass("disabled")) {
				event.stopPropagation()
			} else {
				$('#rename').val('');
				$('#rename').val($('#project-navegator .active a').text().slice(0, -2));
			}
		}

		function handlerRenameAcceptClick(event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				if ($('#rename').val() != '') {
					if ($("#" + $('#project-navegator .active').attr('name')).attr('path') == ' ') {
						update_nameProject(path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#rename').val()), true);
					} else {
						update_nameProject(path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#rename').val()), false);
					}
				}
			}
		}

		function handlerAddProjectClick(event) {
			event.preventDefault();
			add_project('Project' + idProject, false);
			idProject += 1;
		}

		function handlerRemoveProjectClick(event) {
			event.preventDefault();
			remove_project(event);
		}

		function handlerNavMiniClick(event) {
			event.preventDefault();
			ipcRenderer.send('nav:mini');
		}

		function handlerNavMaxiClick(event) {
			event.preventDefault();
			ipcRenderer.send('nav:maxi');
		}

		function handlerNavExitClick(event) {
			event.preventDefault();
			ipcRenderer.send('nav:exit');
		}

		function handlerFileOpenClick(event) {
			event.preventDefault();
			ipcRenderer.send('file:open');
		}

		function handlerSeparatorClick(event) {
			event.preventDefault();
			if ($('#blocks-container').css('display') != 'none') {
				$('#blocks-container').css('display', 'none');
				$('#separator').css('left', '1px').html('&raquo;');
				$('#workspace-container').css('left', '11px');
				$('#project-navegator').css('left', '26px');
				update_tabs();
			} else {
				$('#blocks-container').css('display', 'block');
				$('#separator').css('left', '301px').html('&laquo;');
				$('#workspace-container').css('left', '311px');
				$('#project-navegator').css('left', '326px');
				update_tabs();
			}
		}

		function handlerBlockMenuOptionClick(event) {
			$(".block-menu-option").removeClass('active')
			$(event.currentTarget).addClass('active')
		}

		function handlerWindowResize(e) {
			update_tabs();
		}

		function handlerBlockClick(event) {
			if (["input", "textarea", "button", "select", "option"].findIndex(value => value == event.target.tagName.toLowerCase()) == -1) {
				if (!$(this).parent().hasClass('block-container')) {
					if (!$(this).parent().hasClass('value-container')) {
						if ($(this).hasClass('selected')) {
							$(this).removeClass('selected')
						}
						else {
							$(".selected").removeClass('selected')
							$(this).addClass('selected');
						}
						event.stopPropagation();
					}
				}
			}
		}

		function handlerRemoveBlocks(event) {
			if (event.keyCode == 46) {
				if ($('.selected').parent().hasClass('value-slot')) {
					$('.selected').parent().html("<input class=\"form-control input-sm\"/>")
				} else {
					$('.selected').remove();
				}
			}
		}

		function handlerUpdateArgs(event) {
			const input = $(this);
			input.attr('value', input.val());
		}

		function handlerRemoveVariable(event) {
			event.preventDefault();
			if (window.confirm('¿Seguro que deseas eliminar esta variable?')) {
				$('ul[name=' + $($(event.currentTarget).parent().parent().children()[0]).text() + ']').remove();
				$(event.currentTarget).parent().parent().remove();
			}
		}

		function handlerAddVariable(event) {
			const varName = $('#variable-name');
			const varType = $('#variable-type');
			if (!varName.val()) return null;
			if (!varType.val()) return null;

			const newVar = $(document.createElement('div'))
				.attr('data-block', 'value')
				.attr('data-name', varName.val())
				.append(
					$(document.createElement('div'))
						.text(varName.val())
				);

			newVar.draggable(
				{
					helper: "clone",
					scroll: false,
					zIndex: 100
				}
			)
			$('#vars').append(newVar);
			$('.variableList').append($(document.createElement('option'))
				.val(varName.val())
				.text(varName.val())
			);
			$('#variables').modal('hide');
			interpreter.options(
				{
					global: [
						...interpreter.options().global,
						{ block: 'execute', command: varType.val() + ' ' + varName.val() }
					]
				}
			);
			varName.val('');
			varType.val('int');

		}

		function handlerTabActive(event) {
			event.preventDefault();
			if ($(event.currentTarget).parent().attr('id') == 'project-navegator') {
				$('#list-projects .active').removeClass('active in');
			} else {
				$('#project-navegator .active').removeClass('active in');
			}
		}

		/* Event Listeners */
		// List Ports
		serialport.list(handlerListPorts);

		// Window Resize
		window.addEventListener('resize', handlerWindowResize);

		// Document Key Press
		$('html')
			.on('keyup', handlerRemoveBlocks);

		// Scroll Left
		$('.scrollbar')
			.bind('scroll', handlerScrollLeft);

		// Refresh Port List
		$('#menu-ports').parent().children('.dropdown-toggle')
			.on('click', handlerRefreshPortList);

		// Block Table Input Change
		$(".block table input")
			.on('change', handlerBlockTableInputChange);

		// Dropdown Click
		$('ul.dropdown-menu [data-toggle=dropdown]')
			.on('click', handlerDropdownClick);

		// Edit Menu Click
		$('#edit-menu')
			.on('click', handlerEditMenuClick);

		// Edit New File Click
		$('#new-file')
			.on('click', handlerNewFileClick);

		// Shortcut New File
		$('#shortcut-file')
			.on('click', handlerNewFileClick);

		// Open File Click
		$('#open-files')
			.on('click', handlerOpenFileClick);

		// Shortcut Open File
		$('#shortcut-open')
			.on('click', handlerOpenFileClick);

		// Save As File Click
		$('#saveas-files')
			.on('click', handlerSaveAsFileClick);

		// Save File Click
		$('#save-files')
			.on('click', handlerSaveFileClick);

		// Shortcut Save
		$('#shortcut-save')
			.on('click', handlerSaveFileClick);

		// Compile
		$('#file-compile')
			.on('click', handlerFileCompileClick);

		// Shortcut Compile
		$('#shortcut-compile')
			.on('click', handlerFileCompileClick);

		// Display rename modal
		$('#rename-project')
			.on('click', handlerRenameProjectClick);

		// Click accept button (rename)
		$('#rename-accept')
			.on('click', handlerRenameAcceptClick);

		// Add New project to projects navegator
		$('#add-project')
			.on('click', handlerAddProjectClick);

		// Remove Project
		$('#project-navegator')
			.on('click', '.close', handlerRemoveProjectClick);

		// Minimize
		$('#nav-mini')
			.on('click', handlerNavMiniClick);

		// Maximize
		$('#nav-maxi')
			.on('click', handlerNavMaxiClick);

		// Close
		$('#nav-exit')
			.on('click', handlerNavExitClick);

		// Open dialog
		$('#file-open')
			.on('click', handlerFileOpenClick);

		// Colapse blocks container
		$('#separator')
			.on('click', handlerSeparatorClick);

		// Block Menu Option
		$(".block-menu-option")
			.on('click', handlerBlockMenuOptionClick);

		$("[data-block]")
			.on('click', handlerBlockClick);

		$("[data-block] input, [data-block] select")
			.on('change', handlerUpdateArgs)
			.on('keypress', handlerUpdateArgs);

		$('#variable-add')
			.on('click', handlerAddVariable);


		/* ---------- Sortable Implementation ---------- */

		function sortableIsAllowed(placeholder, placeholderParent, currentItem) {
			if (placeholderParent) {
				event.stopPropagation();
				if (placeholderParent.hasClass('locked')) {

					return false;

				} else {
					if (currentItem.attr('data-block') == "else") {
						if (placeholder.prev().attr('data-block') != "if") {
							return false;
						} else {
							return true;
						}
					} else {
						if (placeholder.next().attr('data-block') == "else") {
							return false;
						} else {
							return true;
						}
					}
				}
			} else {
				if (currentItem.attr('data-block') == "else") {
					if (placeholder.prev().attr('data-block') != "if") {
						return false;
					} else {
						return true;
					}
				} else {
					if (placeholder.next().attr('data-block') == "else") {
						return false;
					} else {
						return true;
					}
				}
			}
			event.stopPropagation();
		}

		$(".block-container").nestedSortable({
			listType: 'ul',
			handle: 'div',
			items: 'li',
			toleranceElement: '> div',
			isAllowed: sortableIsAllowed,
			connectWith: ".sortable",
			remove: function (event, ui) {
				const item = $(ui.item.clone());
				item.find(".value-slot").droppable(
					{
						accept: "div[data-block='value']",
						drop: valueSlotDrop
					}
				);
				item.on('click', handlerBlockClick);
				item.find('input, select')
					.on('change', handlerUpdateArgs)
					.on('keypress', handlerUpdateArgs);
				$(this).html(item);
			}
		})

		$('.sortable').nestedSortable({
			listType: 'ul',
			handle: 'div',
			items: 'li',
			toleranceElement: '> div',
			cancel: "div[data-block='value'],input,textarea,button,select,option,input,textarea,button,select,option",
			isAllowed: sortableIsAllowed
		});

		/* --------------------------------------------- */

		/* ---------- Drag and Drop system ---------- */

		function valueSlotDrop(event, ui) {
			const droppedItem = $(ui.draggable).clone().attr("style", null);
			if ($(ui.draggable).parent().hasClass('value-slot')) {
				$(ui.draggable).parent().html("<input class=\"form-control input-sm\"/>")
				$(ui.draggable).remove()
			}
			droppedItem.draggable(
				{
					helper: 'original',
					scroll: false,
					revert: 'invalid',
					revertDuration: 0
				}
			);
			droppedItem.find('.value-slot').droppable(
				{
					accept: "div[data-block='value']",
					drop: valueSlotDrop,
					greedy: true,
					tolerance: 'pointer'
				}
			);
			droppedItem.on('click', handlerBlockClick)
			$(this).html(droppedItem);
		}

		$("div[data-block='value']").draggable(
			{
				helper: "clone",
				scroll: false,
				zIndex: 100
			}

		);

		$(".value-slot").droppable(
			{
				accept: "div[data-block='value']",
				drop: valueSlotDrop,
				greedy: true,
				tolerance: 'pointer'
			}
		);

		/* ------------------------------------------ */

		/* IPC Renderer Handlers */

		function handlerIpcRendererFileCompile(event) {
			if ($('#file-compile').parent().hasClass('disabled') == true) {
				$('#file-compile').parent().removeClass('disabled');
			}
		}

		function handlerIpcRendererContentData(event, data, filepath) {
			newId = path.basename(filepath);
			if ($('li[name="' + newId.replace('.', 'punto') + '"]').length == 0) {
				add_project(newId, true, data);
			}
		}

		function handlerIpcRendererUpdateNameProject(event, filepath) {
			update_nameProject(filepath);
			ipcRenderer.send('ready:tosave', ($("#" + $('#project-navegator .active').attr('name')).clone().removeClass('active').removeClass('in')).prop('outerHTML'), filepath);
		}

		function handlerIpcRendererLogOpen(event, title) {
			$('#ipc-renderer-modal .modal-footer').css('display', 'none');
			$('#ipc-renderer-modal').modal({
				backdrop: 'static',
				keyboard: false
			});
			$('#ipc-renderer-modal .modal-title').text(title)
		}

		function handlerIpcRendererLogWrite(event, message) {
			$('#ipc-renderer-modal .modal-body').text(message);
		}

		function handlerIpcRendererLogEnd(event) {
			$('#ipc-renderer-modal .modal-footer').css('display', 'block');
		}

		/* IPC Renderer Listeners */
		ipcRenderer.on('file:compile', handlerIpcRendererFileCompile);
		ipcRenderer.on('contentData', handlerIpcRendererContentData);
		ipcRenderer.on('update:name-project', handlerIpcRendererUpdateNameProject);
		ipcRenderer.on('log:open', handlerIpcRendererLogOpen);
		ipcRenderer.on('log:write', handlerIpcRendererLogWrite);
		ipcRenderer.on('log:end', handlerIpcRendererLogEnd);

		//Keyboard Shortcuts
		ipcRenderer.on('Shortcut:new', () => { $('#new-file').triggerHandler('click'); });
		ipcRenderer.on('Shortcut:open', () => { $('#open-files').triggerHandler('click'); });
		ipcRenderer.on('Shortcut:save', () => { $('#save-files').triggerHandler('click'); });
		ipcRenderer.on('Shortcut:compile', () => { $('#file-compile').triggerHandler('click'); });
		ipcRenderer.on('Shortcut:variables', () => { $('#variables').modal('show'); });

	</script>
</body>

</html>
<!DOCTYPE html>
<html style="overflow: hidden;">

<head>
	<title>TIDE Blocks</title>
	<link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="./css/scrollbar.css">
	<link rel="stylesheet" type="text/css" href="./css/custom.css">
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<link rel="stylesheet" type="text/css" href="./css/block.css">
	<script>window.$ = window.jQuery = require('./js/jquery.min.js');</script>
	<script>require('./js/jquery-ui.min.js');</script>
	<script>require('./js/bootstrap.min.js');</script>
</head>

<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand">TIDE Blocks</a>
			</div>
			<ul class="nav navbar-nav">
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Archivo</a>
					<ul class="dropdown-menu">
						<li><a id="new-file">Nuevo Archivo</a></li>
						<li><a id="open-files">Abrir</a></li>
						<li><a id="save-files">Guardar</a></li>
						<li><a id="saveas-files">Guardar Como</a></li>
						<li class="divider"></li>
						<li><a>Exportar</a></li>
						<li><a id="file-compile">Compilar</a></li>
						<li class="divider"></li>
						<li class="dropdown dropdown-submenu">
							<a class="dropdown-toggle" data-toggle="dropdown">Preferencias</a>
							<ul class="dropdown-menu">
								<li class="dropdown dropdown-submenu">
									<a class="dropdown-toggle" data-toggle="dropdown">Puerto</a>
									<ul class="dropdown-menu" id="menu-ports">
									</ul>
								</li>
							</ul>
						</li>
						<li class="divider"></li>
						<li><a>Salir</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a id="edit-menu" class="dropdown-toggle" data-toggle="dropdown">Edición</a>
					<ul class="dropdown-menu">
						<li><a>Undo</a></li>
						<li><a>Redo</a></li>
						<li class="divider"></li>
						<li><a>Cortar</a></li>
						<li><a>Copiar</a></li>
						<li><a>Pegar</a></li>
						<li><a>Borrar</a></li>
						<li class="divider"></li>
						<li><a id="rename-project" data-toggle="modal" data-target="#rename-modal" href=""> Cambiar
								nombre</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown">Ayuda</a>
					<ul class="dropdown-menu">
						<li><a>Aprende más</a></li>
						<li><a>Documentación</a></li>
						<li><a>Acerca de nosotros</a></li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a id="nav-mini"><span class="glyphicon glyphicon-minus"></span></a></li>
				<li><a id="nav-maxi"><span class="glyphicon glyphicon-unchecked"></span></a></li>
				<li><a id="nav-exit"><span class="glyphicon glyphicon-remove"></span></a></li>
			</ul>
		</div>
	</nav>
	<main class="scrollbar scrollbar-default">
		<div id="blocks-container">
			<div id="block-menu" class="row">
				<button class="block-menu-option btn btn-default btn-sm col-xs-6" href="#vars" data-toggle="tab"
					aria-expanded="true">Variables</button>
				<button class="block-menu-option btn btn-default btn-sm col-xs-6" href="#controls" data-toggle="tab"
					aria-expanded="true">Control</button>
				<button class="block-menu-option btn btn-default btn-sm col-xs-6" href="#operators" data-toggle="tab"
					aria-expanded="true">Operadores</button>
				<button class="block-menu-option btn btn-default btn-sm col-xs-6" href="#makers" data-toggle="tab"
					aria-expanded="true">Maker</button>
			</div>
			<div id="block-content" class="tab-content">
				<div class="tab-pane fade block-section" id="vars">
					<div class="block-container">
						<p>Variables</p>
					</div>
				</div>
				<div class="tab-pane fade block-section" id="controls">
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='delay' data-value="1000" style="margin-bottom: -1px">
								<table>
									<tbody>
										<tr>
											<td style="padding-right: 10px">Esperar</td>
											<td>
												<input class="form-control input-sm" min="0" max="4294967295"
													type="number" value="1000" style="width:100px" />
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<div class="tab-pane fade block-section" id="operators">
					<div class="block-container">
						<p>Operadores</p>
					</div>
				</div>
				<div class="scrollbar scrollbar-primary tab-pane fade block-section" id="makers">
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-w-on'>Encender LED Blanco</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-r-on'>Encender LED Rojo</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-y-on'>Encender LED Amarillo</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-g-on'>Encender LED Verde</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-w-off'>Apagar LED Blanco</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-r-off'>Apagar LED Rojo</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-y-off'>Apagar LED Amarillo</div>
						</div>
					</div>
					<div class="block-container">
						<div class="block">
							<div class="block-default" data-block='block-led-g-off'>Apagar LED Verde</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--div class="block-container">
				<div id="Setter" class="block block-primary">Primary</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-success">Success</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-info">Info</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-warning">Warning</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="block block-danger">Danger</div>
			</div-->
		<!--div class="test-block-container">
				<div class="test-block block-if">
					<div><div class="block-header">Si true entonces</div></div>
					<div><div class="block-body sortable"></div></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-default">Default
					<div class="sortable"
						style="position: relative; top: 10px; left: 10px; padding-bottom:20px; background-color: rgba(255,0,0,0.5)">
					</div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-primary">Primary
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-success">Success
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-info">Info
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-warning">Warning
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div>
			<div class="block-container">
				<div id="Setter" class="container-block container-block-danger">Danger
					<div class="sortable" style="position: relative; top: 10px; left: 10px; padding-bottom:20px"></div>
				</div>
			</div-->
		</div>
		<button type="button" id="separator" class="btn btn-default">&laquo;</button>
		<div>
			<ul id="project-navegator" class="nav nav-tabs row">
				<li id="add-project-btn" class=""><a id="add-project" aria-expanded="true">+</a></li>
				<li id="hidden-projects-btn" class="dropdown">
					<a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="true">
						<span class="caret"></span>
					</a>
					<ul id="list-projects" class="dropdown-menu dropdown-menu-right"></ul>
				</li>
			</ul>
		</div>

		<div id="workspace-container" class="scrollbar scrollbar-primary">
			<div id="project-content" class="tab-content"></div>
		</div>
		<div class="modal" id="rename-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">Cambiar nombre de proyecto</h4>
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					<div class="modal-body">
						Nuevo nombre: <input id="rename" type="text">
					</div>
					<div class="modal-footer">
						<button id="rename-accept" class="btn btn-default" type="button"
							data-dismiss="modal">Aceptar</button>
						<button id="rename-cancel" class="btn btn-danger" type="button"
							data-dismiss="modal">Cancelar</button>
					</div>
				</div>
			</div>
		</div>
	</main>
	<script>
		/* Imports */

		const electron = require('electron');
		const { ipcRenderer } = electron;
		const html2json = require('html-to-json');
		const path = require('path');
		const serialport = require('serialport');

		serialport.list((e, p) => {
			$('#menu-ports').html(null)
			p.forEach(el => {
				$('#menu-ports').append($(document.createElement('li'))
					.html($(document.createElement('a'))
						.text(el.comName)
						.click(() => {
							ipcRenderer.send('set:port', el.comName);
						})
					)
				);
			});
		});

		$('#menu-ports').parent().children('.dropdown-toggle').click(() => {
			serialport.list((e, p) => {
				$('#menu-ports').html(null)
				p.forEach(el => {
					$('#menu-ports').append($(document.createElement('li'))
						.html($(document.createElement('a'))
							.text(el.comName)
							.click(() => {
								ipcRenderer.send('set:port', el.comName);
							})
						)
					);
				});
			});
		})
		/*
		$(document).ready(function(event) {
			$('.block-section').css('height', "calc(100vh - "+((parseInt($('.block-menu-option').css('height'))*4)+parseInt($('.navbar').css('height')))+"px)");
		});*/
		/* Event listeners */

		$('.scrollbar').bind('scroll', function () {
			if ($(this).scrollLeft() !== 0) {
				$(this).scrollLeft(0);
			}
		});

		// Input Change
		$(".block table input").change(function (event) {
			event.currentTarget
				.parentElement
				.parentElement
				.parentElement
				.parentElement
				.parentElement
				.setAttribute('data-value', event.currentTarget.value);
		})

		$('ul.dropdown-menu [data-toggle=dropdown]').on('click', function (event) {
			event.preventDefault();
			event.stopPropagation();
			$(this).parent().siblings().removeClass('open');
			$(this).parent().toggleClass('open');
		});

		//id Para archivos nuevos, pero no existentes
		let idProject = 0;
		//Edit menu click
		$('#edit-menu').on('click', function (event) {
			if ($('#project-navegator .active').attr('name') == null) {
				$('#rename-project').parent().addClass('disabled');
			} else {
				$('#rename-project').parent().removeClass('disabled');
			}
		});

		//New File
		$('#new-file').on('click', function (event) {
			event.preventDefault();
			add_project('Project' + idProject, false);
			idProject += 1;
		});
		// Open file
		$('#open-files').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('open:files');
		});
		//Saveas Files
		$('#saveas-files').on('click', function (event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				ipcRenderer.send('saveas:files');
			}
		});
		//Save Files
		$('#save-files').on('click', function (event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				if ($('#project-navegator .active').attr('path') == ' ') {
					ipcRenderer.send('saveas:files');
				} else {
					ipcRenderer.send('ready:tosave', ($("#" + $('#project-navegator .active').attr('name')).clone().removeClass('active').removeClass('in')).prop('outerHTML'), path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#project-navegator .active a').text().slice(0, -2)));
				}
			}
		});

		// Compile
		$('#file-compile').on('click', function (event) {
			event.preventDefault();
			if ($('#file-compile').parent().hasClass('disabled') == false) {
				if ($("#" + $("#project-navegator .active").attr('name')).html()) {
					html2json.parse($("#" + $("#project-navegator .active").attr('name')).html(), function (data) {
						if (data.length) {
							if (data[0].children) {

								$('#file-compile').parent().addClass('disabled');
								ipcRenderer.send('file:compile', data[0].children);
							}
						}
					})
				}
			}
		});
		//Display rename modal
		$('#rename-project').on('click', function (event) {
			event.preventDefault();
			if ($(this).parent().hasClass("disabled")) {
				event.stopPropagation()
			} else {
				$('#rename').val('');
				$('#rename').val($('#project-navegator .active a').text().slice(0, -2));
			}
		});

		//Click accept button (rename)
		$('#rename-accept').on('click', function (event) {
			event.preventDefault();
			if ($('#project-navegator .active').attr('name') != null) {
				if ($('#rename').val() != '') {
					if ($("#" + $('#project-navegator .active').attr('name')).attr('path') == ' ') {
						update_nameProject(path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#rename').val()), true);
					} else {
						update_nameProject(path.resolve($("#" + $('#project-navegator .active').attr('name')).attr('path'), $('#rename').val()), false);
					}
				}
			}
		});
		//Add New project to projects navegator
		$('#add-project').on('click', function (event) {
			event.preventDefault();
			add_project('Project' + idProject, false);
			idProject += 1;
		});
		//Remove Project
		$('#project-navegator').on('click', '.close', function (event) {
			event.preventDefault();
			remove_project(event);
		});
		// Minimize
		$('#nav-mini').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:mini');
		});
		// Maximize
		$('#nav-maxi').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:maxi');
		});
		// Close
		$('#nav-exit').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('nav:exit');
		});
		// Open dialog
		$('#file-open').on('click', function (event) {
			event.preventDefault();
			ipcRenderer.send('file:open');
		});
		// Colapse blocks container

		/**/
		$('#separator').on('click', function (event) {
			event.preventDefault();
			if ($('#blocks-container').css('display') != 'none') {
				$('#blocks-container').css('display', 'none');
				$('#separator').css('left', '1px');
				$('#workspace-container').css('left', '11px');
				$('#project-navegator').css('left', '26px');
				update_tabs();
			} else {
				$('#blocks-container').css('display', 'block');
				$('#separator').css('left', '301px');
				$('#workspace-container').css('left', '311px');
				$('#project-navegator').css('left', '326px');
				update_tabs();
			}
		});

		$(".block-menu-option").click(function (event) {
			$(".block-menu-option").removeClass('active')
			$(event.currentTarget).addClass('active')
		});

		window.addEventListener('resize', function (e) {
			e.preventDefault();
			//$('.block-section').css('height', "calc(100vh - "+((parseInt($('.block-menu-option').css('height'))*4)+parseInt($('.navbar').css('height')))+"px)");
			update_tabs();
		})

		function update_tabs() {
			$.each($('#project-navegator').children(), function (indx, tab) {
				if ((((indx + 1) * $(tab).width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width() > $('#project-navegator').width()) || $('#project-navegator').children().length - 1 == 1) && (tab != $('#add-project').parent()[0] && tab != $('#list-projects').parent()[0])) {
					$(tab).remove();
				}
			});
			$.each($('#list-projects').children(), function (indx, tab) {
				if ($('li[name="' + $(tab).attr('name') + '"]').length == 1) {
					if (((($('#project-navegator').children().length - 1) * $(tab).width() + $('#add-project-btn').width() + $('#hidden-projects-btn').width()) < $('#project-navegator').width() || $('#project-navegator').children().length - 1 == 1) && (tab != $('#add-project').parent()[0] && tab != $('#list-projects').parent()[0])) {
						$($(tab).clone()).insertBefore($('#add-project').parent());
					}
				}
			});
		}

		function add_project(arg, isNew, filecontent = null) {
			nameProject = arg;
			newPath = ' '
			arg = arg.replace('.', 'punto');
			if (!isNew) nameProject = "Nuevo Proyecto";
			if (filecontent) {
				$('#project-content').append($($.parseHTML(filecontent))
					.sortable({
						connectWith: ".sortable",
						receive: sortable_receive,
						change: sortable_update,
						over: sortable_update,
						out: sortable_update
					}).disableSelection()
				);
				newPath = $('#' + arg).attr('path');
			} else {
				$('#project-content').append($(document.createElement('div'))
					.attr('id', arg)
					.attr('path', ' ')
					.attr('class', 'tab-pane fade sortable tab-project')
					.sortable({
						connectWith: ".sortable",
						receive: sortable_receive,
						change: sortable_update,
						over: sortable_update,
						out: sortable_update
					}).disableSelection()
				);
			}
			$('#add-project').parent().before($(document.createElement('li'))
				.attr('name', arg)
				.attr('class', 'tab-design')
				.attr('path', newPath)
				.append($(document.createElement('a'))
					.attr('href', '#' + arg)
					.attr('data-toggle', 'tab')
					.attr('aria-expanded', 'false')
					.text(nameProject)
					.append($(document.createElement('button'))
						.attr('class', 'close')
						.attr('type', 'button')
						.text(' x')
					)
				)
			);
			$('#list-projects').append($(document.createElement('li'))
				.attr('name', arg)
				.attr('class', 'tab-design')
				.attr('path', newPath)
				.append($(document.createElement('a'))
					.attr('href', '#' + arg)
					.attr('data-toggle', 'tab')
					.attr('aria-expanded', 'false')
					.text(nameProject)
					.append($(document.createElement('button'))
						.attr('class', 'close')
						.attr('type', 'button')
						.text(' x')
					)
				)
			);
			update_tabs();
		}

		function remove_project(event) {
			$($(event.currentTarget).parent().attr('href')).remove();
			$.each($('li[name="' + $(event.currentTarget).parent().attr('href').substr(1) + '"]'), function (indx, tab) {
				tab.remove();
			});
			update_tabs();
		}

		function update_element(element, sumhb) {
			if (sumhb < 0) {
				sumhb = 0;
			}
			$(element).css({
				'background-position': '0px 0px, 80px 0px, 130px 0px, 0px 10px, 80px 10px, 130px 10px, 0px 20px, 80px 20px, 130px 20px, 0px 40px, 80px 40px, 130px 40px, 0px ' + (40 + sumhb) + 'px, 80px ' + (40 + sumhb) + 'px, 130px ' + (40 + sumhb) + 'px, 0px ' + (60 + sumhb) + 'px, 80px ' + (60 + sumhb) + 'px, 130px ' + (60 + sumhb) + 'px, 0px ' + (70 + sumhb) + 'px, 80px ' + (70 + sumhb) + 'px, 130px ' + (70 + sumhb) + 'px',
				'background-size': '80px 10px, 50px 10px, 10px 10px, 80px 10px, 50px 10px, 10px 10px, 80px 20px, 50px 20px, 10px 20px, 80px ' + sumhb + 'px, 50px ' + sumhb + 'px, 10px ' + sumhb + 'px, 80px 20px, 50px 20px, 10px 20px, 80px 10px, 50px 10px, 10px 10px, 80px 15px, 50px 15px, 10px 15px',
				'min-height': (85 + sumhb) + 'px',
				'height': (85 + sumhb) + 'px',
				'max-height': (85 + sumhb) + 'px'
			});
		}

		function sortable_update(event, ui) {
			var ws = $('#workspace-container')
			if (ws.length) {
				var bs = ws[0].children;
				for (var i = 0; i < bs.length; i++) {
					var b = bs[i];
					if ((' ' + b.className + ' ').indexOf(' container-block ') > -1) {
						update_element(b, sum_height_blocks(b) - 20)
					}
				}
			}
		}

		function sum_height_blocks(element) {
			var cn = $(element).find('.sortable')
			var sumhb = 0;
			if (cn.length) {
				var bs = cn[0].children;
				for (var i = 0; i < bs.length; i++) {
					var b = bs[i];
					if ((' ' + b.className + ' ').indexOf(' container-block ') > -1) {
						update_element(b, sum_height_blocks(b) - 20)
					}
					sumhb += parseInt($(b).css('height')) + parseInt($(b).css('margin-bottom'));
				}
			}
			return sumhb;
		}

		function sortable_receive(event, ui) {
			$('.sortable').sortable({
				connectWith: ".sortable",
				receive: sortable_receive,
				change: sortable_update,
				over: sortable_update,
				out: sortable_update,
			});
		}

		$(".block-container").sortable({
			connectWith: ".sortable",
			remove: function (event, ui) {
				$(this).html(ui.item.clone())
			},
			change: sortable_update,
			over: sortable_update,
			out: sortable_update
		}).disableSelection();

		$(".sortable").sortable({
			connectWith: ".sortable",
			receive: sortable_receive,
			change: sortable_update,
			over: sortable_update,
			out: sortable_update
		}).disableSelection();
		/**/
		/*
		function sortableRemove(event, ui) {
			$(this).html(ui.item.clone())
		}

		function sortableReceive(event, ui) {
			$('.sortable').sortable({
				connectWith: ".sortable",
				receive: sortableReceive
			});
		}

		$(".test-block-container").sortable({
			connectWith: ".sortable",
			remove: sortableRemove
		}).disableSelection();

		$(".sortable").sortable({
			connectWith: ".sortable",
			receive: sortableReceive
		})
		/**/

		/* IPC Renderer listeners */

		function fileCompile(event, error, stdout, stderr) {
			console.log(event, error, stdout, stderr);
			if ($('#file-compile').parent().hasClass('disabled') == true) {
				$('#file-compile').parent().removeClass('disabled');
				if (error) {
					console.log(error.message);
				} else {
					console.log('Success.');
				}
			}
		}

		function update_nameProject(filepath, isNew) {
			newId = path.basename(filepath);
			if (isNew) {
				newPath = ' '
			} else {
				newPath = path.dirname(filepath);
			}
			$("#" + $('#project-navegator .active').attr('name')).attr('path', newPath);
			$("li[name='" + $('#project-navegator .active').attr('name') + "']").attr('path', newPath);
			$("#" + $('#project-navegator .active').attr('name')).attr('id', newId.replace('.', 'punto'));
			$("li[name='" + $('#project-navegator .active').attr('name') + "'] a").attr('href', '#' + newId.replace('.', 'punto'));
			$("li[name='" + $('#project-navegator .active').attr('name') + "'] a").text(newId);
			$("li[name='" + $('#project-navegator .active').attr('name') + "'] a").append($(document.createElement('button'))
				.attr('class', 'close')
				.attr('type', 'button')
				.text(' x')
			);
			$("li[name='" + $('#project-navegator .active').attr('name') + "']").attr('name', newId.replace('.', 'punto'));
		}

		ipcRenderer.on('file:compile', fileCompile);


		ipcRenderer.on('contentData', (event, data, filepath) => {
			newId = path.basename(filepath);
			if ($('li[name="' + newId.replace('.', 'punto') + '"]').length == 0) {
				add_project(newId, true, data);
			}
		});

		ipcRenderer.on('update:name-project', (event, filepath) => {
			update_nameProject(filepath);
			ipcRenderer.send('ready:tosave', ($("#" + $('#project-navegator .active').attr('name')).clone().removeClass('active').removeClass('in')).prop('outerHTML'), filepath);
		});
	</script>
</body>

</html>